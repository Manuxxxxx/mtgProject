<!DOCTYPE html>
<html>
<head>
  <title>MTG Synergy Graph with UMAP Layout</title>
  <script src="https://unpkg.com/cytoscape/dist/cytoscape.min.js"></script>
  <style>
    #cy { width: 100%; height: 90vh; border: 1px solid #ccc; }
    #controls { padding: 10px; }
  </style>
</head>
<body>
  <div id="controls">
    <label for="sets-select">Select Sets (Ctrl+Click multiple):</label><br/>
    <select id="sets-select" multiple size="8" style="width:300px;">
      {% for s in sets %}
      <option value="{{s}}">{{s}}</option>
      {% endfor %}
    </select>
    <br/><br/>
    <label for="threshold-range">Synergy Threshold: <span id="threshold-val">0.9</span></label><br/>
    <input type="range" id="threshold-range" min="0" max="1" step="0.01" value="0.9" style="width:300px;">
  </div>
  <div id="cy"></div>

<script>
  const cy = cytoscape({
    container: document.getElementById('cy'),
    style: [
      { selector: 'node', style: { 'label': 'data(label)', 'text-valign': 'center', 'color': '#000', 'background-color': '#61bffc' } },
      { selector: 'edge', style: { 'width': 'data(width)', 'line-color': '#ccc', 'curve-style': 'bezier' } },
    ],
    layout: { name: 'preset' }  // use positions from backend
  });

  const setsSelect = document.getElementById('sets-select');
  const thresholdRange = document.getElementById('threshold-range');
  const thresholdVal = document.getElementById('threshold-val');

  async function loadGraph() {
    const selectedSets = Array.from(setsSelect.selectedOptions).map(opt => opt.value);
    const minScore = thresholdRange.value;

    if(selectedSets.length === 0) {
      cy.elements().remove();
      return;
    }

    const params = new URLSearchParams();
    selectedSets.forEach(s => params.append('sets[]', s));
    params.append('min_score', minScore);

    const res = await fetch('/graph_data?' + params.toString());
    const data = await res.json();

    cy.elements().remove();
    cy.add(data.nodes);
    cy.add(data.edges);
    // layout is preset, positions assigned from server
  }

  // Initial load with first set selected by default
  setsSelect.selectedIndex = 0;
  loadGraph();

  setsSelect.addEventListener('change', loadGraph);
  thresholdRange.addEventListener('input', () => {
    thresholdVal.textContent = thresholdRange.value;
  });
  thresholdRange.addEventListener('change', loadGraph);
</script>

</body>
</html>
