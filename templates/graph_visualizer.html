<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Synergy Graph</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.24.0/cytoscape.min.js"></script>
  <style>
    #cy { width: 100%; height: 90vh; border: 1px solid #ccc; }
    #controls { margin: 10px; }
    select[multiple] { width: 400px; height: 160px; }
  </style>
</head>
<body>
  <div id="controls">
    <label>Card Sets (select 1â€“5):</label><br>
    <select id="setSelector" multiple size="8"></select><br><br>

    <label>Min Synergy Score:</label>
    <input type="range" id="minScore" min="0.5" max="1.0" step="0.01" value="0.9">
    <span id="minScoreVal">0.9</span><br><br>

    <label>Max Synergy Score:</label>
    <input type="range" id="maxScore" min="0.5" max="1.0" step="0.01" value="1.0">
    <span id="maxScoreVal">1.0</span><br><br>

    <label>UMAP Scale:</label>
    <input type="range" id="scaleSlider" min="50" max="2500" step="50" value="500">
    <span id="scaleVal">1000</span><br><br>

    <button onclick="loadGraph()">Update Graph</button>
  </div>

  <div id="cy"></div>

  <script>
    const sets = {{ sets | tojson }};
    const selector = document.getElementById('setSelector');

    for (const [code, name] of Object.entries(sets)) {
      const opt = document.createElement('option');
      opt.value = code;
      opt.textContent = name;
      selector.appendChild(opt);
    }

    function loadGraph() {
      const selectedSets = Array.from(selector.selectedOptions).map(opt => opt.value);
      const minScore = parseFloat(document.getElementById('minScore').value);
      const maxScore = parseFloat(document.getElementById('maxScore').value);
      const scale = parseInt(document.getElementById('scaleSlider').value);

      if (selectedSets.length === 0) {
        alert('Please select at least one set.');
        return;
      }

      fetch(`/graph_data?${selectedSets.map(s => 'sets[]=' + s).join('&')}&min_score=${minScore}&max_score=${maxScore}&scale=${scale}`)
        .then(res => res.json())
        .then(data => {
          const cy = cytoscape({
            container: document.getElementById('cy'),
            elements: [...data.nodes, ...data.edges],
            style: [
              { selector: 'node', style: { 'label': 'data(label)', 'background-color': '#00cc96', 'font-size': 20 }},
              { selector: 'edge', style: { 'width': 'data(width)', 'line-color': '#888' }}
            ],
            layout: {
              name: 'preset',
              fit: true,
              padding: 20
            }
          });
        });
    }

    document.getElementById('minScore').oninput = e => document.getElementById('minScoreVal').textContent = e.target.value;
    document.getElementById('maxScore').oninput = e => document.getElementById('maxScoreVal').textContent = e.target.value;
    document.getElementById('scaleSlider').oninput = e => document.getElementById('scaleVal').textContent = e.target.value;

    // Load initial graph
    setTimeout(loadGraph, 1000);
  </script>
</body>
</html>
